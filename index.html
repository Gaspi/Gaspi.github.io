<!DOCTYPE html>
<html lang="en">
<head>
  <title> Dedukti </title>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="ressources/favicon.png"/>
  <!-- Leaflet and Bootstrap: CSS style -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/fontawesome.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
  <!-- Syntax coloring: CSS style -->
  <link rel="stylesheet" href="ressources/syntax_coloring.css">
</head>
<body>

<div class="container-fluid main-wrapper">
  <div class="row justify-content-left">
    <div class="col justify-content-center" style="max-width: 600px; background: #f2f2f2;">
      <div class="mx-2">
        <button type="button" class="btn btn-primary btn-lg my-2 w-100" onclick="process_all_instructions()">
          Type Check !
        </button>
        <div class="my-2 dropdown">
          <button type="button" class="btn btn-success dropdown-toggle btn-lg w-100" id="dropdown_examples" data-bs-toggle="dropdown" aria-expanded="false">
            Load an example
          </button>
          <ul class="dropdown-menu w-100" aria-labelledby="dropdown_examples">
            <li><a class="dropdown-item" href="#" onclick="load_example(this.innerHTML)">intro.dk</a></li>
            <li><a class="dropdown-item" href="#" onclick="load_example(this.innerHTML)">intro-advanced.dk</a></li>
            <li><a class="dropdown-item" href="#" onclick="load_example(this.innerHTML)">FO-cons.dk</a></li>
            <li><a class="dropdown-item" href="#" onclick="load_example(this.innerHTML)">FO-rew.dk</a></li>
            <li><a class="dropdown-item" href="#" onclick="load_example(this.innerHTML)">FO-nat.dk</a></li>
            <li><a class="dropdown-item" href="#" onclick="load_example(this.innerHTML)">arities.dk</a></li>
            <li><a class="dropdown-item" href="#" onclick="load_example(this.innerHTML)">arities2.dk</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><input class="ml-2" type="file" id="file-input"></li>
            <li><a class="dropdown-item" href="#" onclick="download_file()">Save current to disk</a></li>
          </ul>
        </div>
      </div>
      <h2 class="text-center">Ouput</h2>
      <div id="logs"></div>
    </div>
    <div class="col">
      <h2 class="text-center">Dedukti</h2>
      <div class="form-outline mx-3 mt-2">
        <div id="editor" class="editor" style="font-family:monospace"></div>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="src/utils.js"></script>
<script src="src/term.js"></script>
<script src="src/context.js"></script>
<script src="src/env.js"></script>
<script src="src/dtree.js"></script>
<script src="src/red.js"></script>
<script src="src/sig.js"></script>
<script src="src/rulechecker.js"></script>
<script src="src/pp.js"></script>
<!--<script src="src/meta_context.js"></script> -->

<script src="ressources/moo.js"></script>
<script src="src/grammar.js"></script>
<script src="ressources/nearley.js"></script>

<script src="ressources/codejar.js"></script>
<script src="ressources/linenumbers.js"></script>

<script>
// Global variables for easy access
var code, instructions, sig;
var editor, highlighter, jar;
var debug = true;

// Example loading
function load_example(filename) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
       // Typical action to be performed when the document is ready:
       jar.updateCode(xhttp.responseText);
       process_all_instructions();
    }
  };
  xhttp.open("GET", "examples/"+filename, true);
  xhttp.send();
}

// File loading
function load_file(file) {
  if (!file) { return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    jar.updateCode(e.target.result);
    process_all_instructions();
  };
  reader.readAsText(file);
}

// Editor content downloading
function download_file() {
  const file = new File([editor.textContent], "dedukti.dk")
  // Create a link and set the URL using `createObjectURL`
  const link = document.createElement("a");
  link.style.display = "none";
  link.href = URL.createObjectURL(file);
  link.download = file.name;

  // It needs to be added to the DOM so it can be clicked
  document.body.appendChild(link);
  link.click();

  // To make this work on Firefox we need to wait
  // a little while before removing it.
  setTimeout(() => {
    URL.revokeObjectURL(link.href);
    link.parentNode.removeChild(link);
  }, 0);
}

// Logs handling
const logs = document.getElementById("logs");
function clear_logs() { logs.innerHTML = ""; }
function log_ok(ln,title,msg)   { log(ln,title,msg,['alert','alert-success']); }
function log_info(ln,title,msg) { log(ln,title,msg,['alert','alert-info']); }
function log_warn(ln,title,msg) { log(ln,title,msg,['alert','alert-warning']); }
function log_err(err) {
  if (err.title) {
    log(err.ln,'ERROR: '+err.title, err.msg, ['alert','alert-danger']);
  } else {
    const msg = (err.msg || err)+"";
    if (msg.startsWith("Syntax error ")) {
      log(err.ln,'SYNTAX ERROR', msg.slice(13), ['alert','alert-danger']);
    } else {
      log(err.ln,'ERROR', err, ['alert','alert-danger']);
    }
  }
}
// Display a new block in the loading area
function log(ln,title,msg,classes=[]) {
  const div = document.createElement('div');
  div.style['white-space']= 'pre-wrap';
  div.innerHTML = (ln?ln+": ":"")+'<strong>['+title+']</strong> '+msg;
  div.classList.add('p-1');
  div.classList.add('m-2');
  classes.forEach((x)=>div.classList.add(x));
  logs.appendChild(div);
}

// Create a Parser object from our grammar.
const parser = new nearley.Parser(nearley.Grammar.fromCompiled(grammar));
const initial_state = parser.save();

// Convert a string to a series of instructions
function parse(code) {
  parser.restore(initial_state);
  parser.feed(code);
  return parser.results[0];
}

// Process a single unscoped instruction
function process_instruction(sig,rulechecker,ins) {
  sig.env.scope_instruction(ins);
  switch (ins[c]) {
    case "Decl":
      sig.declare_symbol(ins);
      log_ok(ins.ln,"Symbol declared",ins.name+" with type " +pp_term(ins.type) );
      break;
    case "DeclConst":
      sig.declare_symbol(ins);
      sig.red.declare_constant(ins.name);
      log_ok(ins.ln,"Constant symbol declared",ins.name+" with type " +pp_term(ins.type) );
      break;
    case "DeclConstP":
      sig.red.declare_constant(ins.name);
      log_ok(ins.ln,"Symbol declared constant",ins.name);
      break;
    case "DeclInj":
      sig.red.declare_injective(ins.name);
      log_ok(ins.ln,"Symbol declared injective",ins.name+" (no check)");
      break;
    case "Def":
      sig.declare_symbol(ins);
      rulechecker.declare_rule( Rew(ins.ln, Ref(ins.name),ins.def,ins.name+"_def") );
      log_ok(ins.ln,"Symbol defined",ins.name+ " as " + pp_term(ins.def));
      break;
    case "Rew":
      rulechecker.declare_rule(ins);
      log_ok(ins.ln,"Rewrite rule added",pp_term(ins.lhs)+ " --\> " + pp_term(ins.rhs));
      break;
    case "Req":
      break;
    case "Eval":
      log_info(ins.ln,"Eval",pp_term(sig.red.nf(ins.term, ins.ctx), ins.ctx)+"\n"+pp_context(ins.ctx));
      break;
    case "Infer":
      log_info(ins.ln,"Infer",pp_term(sig.infer(ins.term, ins.ctx), ins.ctx)+"\n"+pp_context(ins.ctx));
      break;
    case "CheckType":
      sig.check(ins.term, ins.type, ins.ctx);
      log_ok(ins.ln,"CheckType",
        pp_term(ins.term, ins.ctx)+" has indeed type "+pp_term(ins.type, ins.ctx)+"\n"+
        pp_context(ins.ctx));
      break;
    case "CheckConv":
      if (sig.red.are_convertible(ins.lhs, ins.rhs)) {
        if (ins.cv) {
          log_ok(ins.ln,"CheckConv",pp_term(ins.lhs,ins.ctx)+" is indeed convertible with "+pp_term(ins.rhs,ins.ctx));
        } else {
          log_warn(ins.ln,"CheckConv",pp_term(ins.lhs,ins.ctx)+" is in fact convertible with "+pp_term(ins.rhs,ins.ctx));
        }
      } else {
        if (ins.cv) {
          log_warn(ins.ln,"CheckConv",pp_term(ins.lhs,ins.ctx)+" is in fact not convertible with "+pp_term(ins.rhs,ins.ctx));
        } else {
          log_ok(ins.ln,"CheckConv",pp_term(ins.lhs,ins.ctx)+" is indeed not convertible with "+pp_term(ins.rhs,ins.ctx));
        }
      }
      break;
    case "Print":
      log_info(ins.ln,"Show",pp_term(ins.term));
      break;
    case "DTree":
      log_info(ins.ln,"DTree","Decision tree for symbol `"+ins.name+"`:\n"+pp_dtrees(sig.red.get(ins.name).decision_trees));
      break;
    default:
      throw "Instruction:\nUnexepected instruction type:"+ins[c];
  }
}

// Main processing loop
function process_all_instructions() {
  clear_logs();
  try {
    // Parsing of raw text code
    code = editor.textContent;
    instructions = parse(code);
    log_ok(null,"Parsing","done.");
    // Reseting the signature
    sig = new Signature();
    rulechecker = new RuleChecker(sig);
    instructions.forEach((i)=>process_instruction(sig,rulechecker,i));
    log_ok(null,"File Checking","All done !","");
  } catch(e) {
    log_err(e);
    if (debug) { throw e; }
  }
}

const dragenter = (e) => {
  e.stopPropagation();
  e.preventDefault();
}
const dragover = (e) => {
  e.stopPropagation();
  e.preventDefault();
}
const drop = (e) => {
  e.stopPropagation();
  e.preventDefault();
  load_file(e.dataTransfer.files[0]);
}

// Only when page is loaded : load intro.dk and start syntax highlighting
window.onload = function () {
  load_example('intro.dk');
  document.getElementById('file-input').onchange = (e)=>load_file(e.target.files[0]);
  editor = document.getElementById('editor');
  editor.addEventListener("dragenter", dragenter, false);
  editor.addEventListener("dragover", dragover, false);
  editor.addEventListener("drop", drop, false);
  highlighter = moo.compile({
      STRING:grammar.Lexer.groups.map(function (g) {
          const ng = Object.assign({}, g); // Deep copy
          ng.value = txt => '<span class="KW '+g.defaultType+'">'+txt+'</span>';
          return ng;
        }),
      myError: moo.error
    });
  const highlight = editor => {
    highlighter.reset(editor.textContent);
    editor.innerHTML = Array.from(highlighter).map(x=>x.value).join('');
  };
  jar = CodeJar(editor, withLineNumbers(highlight, options={ color:'white' }), {tab: ' '.repeat(4)});
};

</script>
